From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: tr7zw <tr7zw@live.de>
Date: Wed, 5 Aug 2020 14:25:50 -0500
Subject: [PATCH] Add GameProfileLookupEvent

Original code by Yatopia, licensed under MIT License

diff --git a/src/main/java/com/destroystokyo/paper/profile/CraftPlayerProfile.java b/src/main/java/com/destroystokyo/paper/profile/CraftPlayerProfile.java
index ef6aab69daa7ab952408b573bff6c6996cbc349a..f585b8f79b8649a3224b04d6540fb1f38eb30dd1 100644
--- a/src/main/java/com/destroystokyo/paper/profile/CraftPlayerProfile.java
+++ b/src/main/java/com/destroystokyo/paper/profile/CraftPlayerProfile.java
@@ -189,9 +189,17 @@ public class CraftPlayerProfile implements PlayerProfile {
 
         boolean isCompleteFromCache = this.completeFromCache(true, onlineMode);
         if (onlineMode && (!isCompleteFromCache || textures && !hasTextures())) {
-            GameProfile result = server.getSessionService().fillProfileProperties(profile, true);
-            if (result != null) {
-                copyProfileProperties(result, this.profile, true);
+            // Sugarcane start
+            org.sugarcanemc.sugarcane.server.events.GameProfileLookupEvent event = new org.sugarcanemc.sugarcane.server.events.GameProfileLookupEvent(!org.bukkit.Bukkit.isPrimaryThread(), profile.getId(), profile.getName());
+            org.bukkit.Bukkit.getPluginManager().callEvent(event);
+            GameProfile eventProfile = event.getGameProfile();
+            if (eventProfile != null) {
+                GameProfile result = eventProfile;
+            } else {
+                GameProfile result = server.getSessionService().fillProfileProperties(profile, true);
+                if (result != null) {
+                    copyProfileProperties(result, this.profile, true);
+                }
             }
             if (this.profile.isComplete()) {
                 server.getProfileCache().add(this.profile);
diff --git a/src/main/java/net/minecraft/world/level/block/entity/SkullBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/SkullBlockEntity.java
index 705d5ebb3d7b40745b318617ea39a7ea785b9504..54ef8e85148ca3dad38e93a1654fd0d0e6ff051d 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/SkullBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/SkullBlockEntity.java
@@ -152,7 +152,15 @@ public class SkullBlockEntity extends BlockEntity {
                 Property property = (Property) Iterables.getFirst(gameprofile1.getProperties().get("textures"), (Object) null);
 
                 if (property == null) {
-                    gameprofile1 = SkullBlockEntity.sessionService.fillProfileProperties(gameprofile1, true);
+                    // Sugarcane start
+                    org.sugarcanemc.sugarcane.server.events.GameProfileLookupEvent event = new org.sugarcanemc.sugarcane.server.events.GameProfileLookupEvent(!org.bukkit.Bukkit.isPrimaryThread(), gameprofile1.getId(), gameprofile1.getName());
+                    org.bukkit.Bukkit.getPluginManager().callEvent(event);
+                    GameProfile eventProfile = event.getGameProfile();
+                    if (eventProfile != null) {
+                        gameprofile1 = eventProfile;
+                    } else {
+                        gameprofile1 = SkullBlockEntity.sessionService.fillProfileProperties(gameprofile1, true);
+                    }
                 }
 
                 GameProfile finalGameprofile = gameprofile1;
